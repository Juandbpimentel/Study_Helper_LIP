generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model Usuario {
  id          Int    @id @default(autoincrement())
  email       String @unique
  senha       String
  nome        String
  versaoToken String @default(uuid()) @map("versao_token")

  //preferências do usuário
  primeiroDiaSemana    DiaSemana @default(Dom) @map("primeiro_dia_semana")
  planejamentoRevisoes Int[]     @default([1, 7, 14]) @map("planejamento_revisoes")

  // Configurações do cronograma / atraso
  maxSlotsPorDia           Int? @map("max_slots_por_dia")
  slotAtrasoToleranciaDias Int  @default(0) @map("slot_atraso_tolerancia_dias")
  slotAtrasoMaxDias        Int  @default(7) @map("slot_atraso_max_dias")
  revisaoAtrasoExpiraDias  Int? @map("revisao_atraso_expira_dias")

  // Ofensiva (streak) e bloqueios (freezes)
  ofensivaAtual           Int       @default(0) @map("ofensiva_atual")
  ofensivaBloqueiosTotais Int       @default(2) @map("ofensiva_bloqueios_totais")
  ofensivaBloqueiosUsados Int       @default(0) @map("ofensiva_bloqueios_usados")
  ofensivaUltimoDiaAtivo  DateTime? @map("ofensiva_ultimo_dia_ativo")
  ofensivaAtualizadaEm    DateTime  @default(now()) @map("ofensiva_atualizada_em")

  cronogramaSemanal   CronogramaSemanal?
  temasDeEstudo       TemaDeEstudo[]
  revisoesProgramadas RevisaoProgramada[]
  registrosEstudo     RegistroEstudo[]

  createdAt       DateTime         @default(now()) @map("created_at")
  updatedAt       DateTime         @updatedAt @map("updated_at")
  slotCronogramas SlotCronograma[]

  googleCalendarIntegration GoogleCalendarIntegration?

  @@map("usuarios")
}

model GoogleCalendarIntegration {
  id Int @id @default(autoincrement())

  usuario   Usuario @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  creatorId Int     @unique

  calendarId String? @map("calendar_id")

  accessToken           String?   @map("access_token")
  refreshTokenEncrypted String?   @map("refresh_token_encrypted")
  tokenType             String?   @map("token_type")
  scope                 String?   @map("scope")
  expiryDate            DateTime? @map("expiry_date")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("google_calendar_integrations")
}

model CronogramaSemanal {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  slotsCronograma SlotCronograma[]

  usuario   Usuario @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  creatorId Int

  @@unique([creatorId])
  @@map("cronogramas_semanais")
}

model SlotCronograma {
  id Int @id @default(autoincrement())

  usuario   Usuario @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  creatorId Int

  diaSemana DiaSemana @map("dia_semana")
  ordem     Int?      @default(0)

  cronograma   CronogramaSemanal @relation(fields: [cronogramaId], references: [id], onDelete: Cascade)
  cronogramaId Int               @map("cronograma_id")

  tema   TemaDeEstudo @relation(fields: [temaId], references: [id], onDelete: Cascade)
  temaId Int          @map("tema_id")

  registros RegistroEstudo[]

  createdAt          DateTime            @default(now()) @map("created_at")
  updatedAt          DateTime            @updatedAt @map("updated_at")
  revisaoProgramadas RevisaoProgramada[]

  googleEventId String? @map("google_event_id")

  @@index([creatorId, diaSemana])
  @@map("slots_cronograma")
}

model TemaDeEstudo {
  id Int @id @default(autoincrement())

  tema      String   @db.VarChar(255)
  descricao String?  @db.VarChar(1000)
  cor       String?  @map("cor") @db.VarChar(7)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  slots     SlotCronograma[]
  registros RegistroEstudo[]

  usuario   Usuario @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  creatorId Int

  @@index([creatorId])
  @@map("temas_de_estudo")
}

model RegistroEstudo {
  id               Int          @id @default(autoincrement())
  tempoDedicado    Int          @map("tempo_dedicado")
  conteudoEstudado String?      @map("conteudo_estudado") @db.VarChar(1000)
  tipoRegistro     TipoRegistro @default(EstudoDeTema) @map("tipo_registro")
  dataEstudo       DateTime     @default(now()) @map("data_estudo")

  tema           TemaDeEstudo?   @relation(fields: [temaId], references: [id], onDelete: Cascade)
  temaId         Int?            @map("tema_id")
  slotCronograma SlotCronograma? @relation(fields: [slotId], references: [id], onDelete: Cascade)
  slotId         Int?            @map("slot_id")

  revisoesGeradas  RevisaoProgramada[] @relation("RegistroOrigem")
  revisaoConcluida RevisaoProgramada?  @relation("RegistroConclusao")

  usuario   Usuario @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  creatorId Int

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([slotId, dataEstudo])
  @@index([creatorId, dataEstudo])
  @@map("registros_estudo")
}

model RevisaoProgramada {
  id            Int           @id @default(autoincrement())
  dataRevisao   DateTime      @map("data_revisao")
  statusRevisao StatusRevisao @default(Pendente) @map("status_revisao")
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")

  registroOrigem   RegistroEstudo @relation("RegistroOrigem", fields: [registroOrigemId], references: [id], onDelete: Cascade)
  registroOrigemId Int            @map("registro_origem_id")

  registroConclusao   RegistroEstudo? @relation("RegistroConclusao", fields: [registroConclusaoId], references: [id])
  registroConclusaoId Int?            @unique @map("registro_conclusao_id")

  slotCronograma   SlotCronograma? @relation(fields: [slotCronogramaId], references: [id])
  slotCronogramaId Int?            @map("slot_id")

  usuario   Usuario @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  creatorId Int

  googleEventId String? @map("google_event_id")

  @@index([creatorId, dataRevisao])
  @@map("revisoes")
}

enum TipoRegistro {
  EstudoDeTema
  Revisao
  EstudoAberto
}

enum StatusRevisao {
  Pendente
  Concluida
  Adiada
  Atrasada
  Expirada
}

enum DiaSemana {
  Dom
  Seg
  Ter
  Qua
  Qui
  Sex
  Sab
}
